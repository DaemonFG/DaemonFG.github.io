---
title: 开放道路目的地POI预测实践
top: false
cover: false
toc: true
mathjax: true
abbrlink: 4d422e54
date: 2019-11-09 17:20:36
password:
summary:
tags: Bayesian Network
categories: LBS
---

### 背景

随着越来越多的无人驾驶项目落地，无人驾驶网约车走上街头，开放道路目的地POI预测开始在落地项目中崭露头角。

从产品的角度看，用户打开网约车软件，在还未输入的情况下，猜测用户的想去的目的地（POI）并以TIPS的形式直接进行提示，该功能从产品上有两个好处：

1. 能够减少用户的输入，如果猜测准确，用户直接点击目的地POI即可；
2. 能提升用户体验和粘性，毕竟用户都是感性的，这样一个功能点如果足够准，就能让用户印象深刻。

### 技术

从业务场景分析看，绝大部分情况下，用户准备叫车的瞬间，心中已经有要去的地点。技术需要做的只是将该POI猜对并提示出来。所以该场景所使用的技术，就和传统的视频，音乐，甚至电商推荐有很大区别：该过程不需要协同，而在乎准确，用户不会因为推荐的POI和他的兴趣相关就会去，在打开软件前，用户就已经做了决定。

换句话说，用户要去的地方是极度个性化的，几乎没有泛化，所以在技术上有以下两点设计：

1. 召回的目的地候选POI就是用户的常去地；
2. 去什么地方仅取决于用户及他所处的上下文，此处上下文包括位置，时间等；
3. 从滴滴发表在2017KDD的论文来看，最有效的场景上下文如下图所示。

![最有效的场景上下文](https://github.com/DaemonFG/blog_image/blob/main/didi-1.jpg?raw=true)

### 算法

#### 一、验证

在滴滴出行2017KDD的论文中，提到了一些有趣的现象：

1. 同一用户在相同的时间段倾向于前往相同的目的地；
2. 出发时间（24小时制）是预测用户预期目的地的最重要因素，其次才是出发地点的经纬度、
3. 可以根据出发时间是工作日还是休息日将数据分为具有不同特征的两组：工作日目的地集中在家庭和工作场所，而休息日的目的地主要集中在购物中心和娱乐场所等；
4. 即使在周末购物，同一位用户也倾向于去固定地点，除非偶尔遇到紧急情况，例如预约医生，商务出行等；
5. 订单的位置为目的地预测提供了有用的信息，而其他信息（例如驾驶员信息，交通状况，行驶速度等）与目的地的相关性较弱。

我们根据2017年5月1日-10月31日海口市每天的订单数据（数据来自[滴滴出行“盖亚”数据开放计划](https://outreach.didichuxing.com/research/opendata/)）验证了以上发现。

#### 二、模型

针对每个用户的数据，对每一个去过的候选目的地，使用高斯分布来构建基于上下文的条件概率分布。之所以使用，之所以使用高斯分布，是从数据上来看，出发上下文和去的目的地之间，分布的确是一个钟形，如图所示。

![特定目的地出发时间分布](https://github.com/DaemonFG/blog_image/blob/main/didi-2.jpg?raw=true)

所以，如果仅考虑时间一个维度，用户出发去特定目的地的分布，符合高斯分布，可以使用贝叶斯模型，公式如下：
$$
p(Y = y_i | X) = \frac{p(X | Y = y_i)p(Y = y_i)}{\sum_{j=1}^{n}p(X | Y = y_j)p(Y = y_j)}
$$
其中 $X$为当前用户所处上下文， $Y = y_i$表示目的地为$y_i$。其模型形式为给定上下文后，计算用户去目的地$y_i$的概率，转化为使用贝叶斯方式计算，此时只要计算用户去各个目的地的先验概率，以及用户去各目的地的上下文概率即可。

先验计算比较直接，直接统计用户去各目的地的频次即可，特定目的地概率统计公式如下：
$$
p(Y = y_i) = \frac{freq(y_i)}{\sum_{j=1}^{n}freq(y_i)}
$$
$P(X|Y=y_i)$将其表示为高斯分布。此处 $X$如果仅包涵时间维度的话，建模为条件概率分布，作如下表示：
$$
T | Y = y_i ～ N(\mu_i, 	\sigma_i^2)
$$
高斯分布仅需要给出数学期望(均值)$\mu$和方差$\sigma_i^2$即可,而两个值通过观测样本即可给出。但此处有个细节，就是时间是以24小时的周期函数，不能直接使用数值方式计算均值$\mu$，所以在此提出计算时间维度$\mu$的方法：
$$
\left\{
\begin{aligned}
\mathop{min}\limits_{\mu}\sum_{k=1}^{m}[|(|t_k - \mu| - 12)| - 12]^2, &  \\ 
s.t. \mu \in [0, 24). &  \\
\end{aligned}
\right.
$$
思路比较直接，其中有两个关键点：

1. 时间以24小时作为周期，那么两个时间的差，不能大于12小时；
2. $\mu$和所有时间点的差值的平方和最小，求解$\mu$即可。

时间和距离两个维度同时使用求$\mu$公式如下：
$$
\left\{
\begin{aligned}
\mathop{min}\limits_{\mu}\sum_{k=1}^{m}[distance(t_k, \mu)]^2, &  \\ 
s.t. \mu \in [0, 24). &  \\
\end{aligned}
\right.
$$

$$
distance(t_1, t_2) =
\left\{
\begin{aligned}
|t_1 - t_2| \quad if|t_1 - t_2|\le 12, &  \\ 
24 - |t_1 -t_2| \quad if|t_1 - t_2| \ge 12.&  \\
\end{aligned}
\right.
$$

同理，可求解方差$\sigma^2$。

以上方法仅使用了时间一个上下文，在实际中较为重要的上下文为时间，出发位置，是否工作日，以相似的方式，将模型构建为多维高斯分布并使用贝叶斯方式即可计算。

#### 三、结果

使用以上方法，即可计算用户在特定场景上下文情况下去特定POI的概率。当用户打开软件时，只需要使用该用户当前的场景上下文，使用以上方法均计算一遍概率，再根据阈值挑出TOP N即可作为预测的结果.

#### 四、不足

##### 优点：

1. 足够简单，结果容易解释。

##### 缺点：

1. 场景上下文使用较少，也不太方便引入更多上下文，例如天气等.
2. 用户行为使用较少，仅使用上下文信息进行单点预测，没有用到用户的行为轨迹信息.

##### 解决思路：

1. 针对缺点1：引入更多的特征，描述能力更强的模型。
2. 针对缺点2：受限于产品使用场景，如果能拿到的数据仅为用户行前的位置信息，以及用户行中的轨迹订单信息，但对用户行前之前的数据一无所知，所以如果从手机厂商的底层操作系统的角度，就能够完整拿到用户轨迹，就能够使用用户长期行为模式，短期轨迹和即时上下文，更加精准地预估用户行为。当然这样也会面临着更大的用户隐私风险，毕竟用户的轨迹信息基本是用户最私密的数据了。

### 参考文献

1. Lingyu Zhang, Tao Hu, Yue Min, Guobin Wu, Junying Zhang, Pengcheng Feng, Pinghua Gong, and Jieping Ye. 2017. [A taxi order dispatch model based on combinatorial optimization](https://www.kdd.org/kdd2017/papers/view/a-taxi-order-dispatch-model-based-on-combinatorial-optimization) Proceedings of the 23rd ACM SIGKDD International Conference on Knowledge Discovery and Data Mining. ACM, 2151--2159. 